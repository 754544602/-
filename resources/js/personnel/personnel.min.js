(function($){var USERS_LIST="";var thisUserObj="";var usersControl={init:function(obj,opt){var me=this;usersControl.thisUserObj=obj;me.setHtml(obj,opt);me.setEvent(obj,opt)},setHtml:function(obj,opt){var controlClass=opt.controlClass||'';var html=$('<div class="yt-users-control '+controlClass+'"><div class="yt-users-model"><input type="text" class="yt-input yt-user-input" placeholder="请输入姓名" /></div><div class="yt-users-list"><label class="yt-read-text" style="margin-left: 5px;">请选择人员：</label><ul></ul></div></div>');return obj.html(html)},setEvent:function(obj,opt){var me=this;me.getUsersDatas(obj,opt);me.events(obj,opt)},events:function(obj,opt){obj.find(".yt-users-model .user-obj").on('contextmenu',function(e){e.preventDefault();});obj.find('.yt-users-model .user-obj').mousedown(function(e){$yt_baseElement.eventStopPageaction();obj.find(".yt-users-model .user-obj").removeClass("check-users");$(this).addClass("check-users");var thisObj=$(this);if(e.which==3){usersControl.setInteractive(obj,opt,thisObj);usersControl.rightButConPosition(e);obj.find("#rightButCon").show();obj.find(".right-button-context .del-only").click(function(){$yt_baseElement.eventStopPageaction();obj.find(".yt-users-list li:not(.more-data)").each(function(i,n){if($(thisObj).data("userData")){if($(n).data("userData").userItcode==$(thisObj).data("userData").userItcode){$(n).removeClass("user-check-li");return false}}});$(thisObj).remove()});obj.find(".right-button-context .del-all").click(function(){$yt_baseElement.eventStopPageaction();obj.find('.yt-users-model .user-obj').remove();obj.find(".yt-users-list li").removeClass("user-check-li")});obj.find(".right-button-context .canel-li").click(function(){$yt_baseElement.eventStopPageaction();$(".right-button-context").remove()})}});obj.find(".yt-users-list li:not(.more-data)").off().on("click",function(){$yt_baseElement.eventStopPageaction();if($(this).hasClass("user-check-li")){$(this).removeClass("user-check-li");var userItcode=$(this).data("userData").userItcode;obj.find(".yt-users-model .user-obj").each(function(i,n){if(userItcode==$(n).data("userData").userItcode){$(n).remove();return false}});return}else{$(this).addClass("user-check-li");var userData=$(this).data("userData");obj.find(".yt-users-model .yt-user-input").before($('<span class="user-obj">'+userData.userName+'、</span>').data("userData",userData));usersControl.events(obj,opt)}});obj.find(".yt-users-model .yt-user-input").on("focus",function(){if(obj.find(".yt-users-model .user-obj").length>0){var usersCode=",";obj.find(".yt-users-model .user-obj").each(function(i,n){usersCode+=$(n).data("userData").userItcode+","});obj.find(".yt-users-list li:not(.more-data)").each(function(i,n){var Itcode=","+$(n).data("userData").userItcode+",";if(usersCode.indexOf(Itcode)>=0){$(n).addClass("user-check-li")}})}obj.find(".yt-users-list").show()});obj.find(".yt-users-model .yt-user-input").on("blur",function(){$(this).val('')});obj.find(".yt-users-model .yt-user-input").off("keyup").on("keyup",function(){usersControl.searchUserInfo(obj,opt,$(this).val())})},getUsersDatas:function(obj,opt){$.ajax({type:'get',url:opt.dataUrl,async:false,data:{params:'',pageIndex:1,pageNum:99999},success:function(data){if(data.flag==0){if(data.data.rows.length>0){USERS_LIST=data.data.rows;usersControl.getMoreData(obj,opt,USERS_LIST)}}},error:function(e){}})},searchUserInfo:function(obj,opt,keyword){var liStr="";obj.find(".yt-users-list ul").empty();var selNum=0;var userList=[];$.each(USERS_LIST,function(i,n){if(keyword!=undefined){if(n.userName.indexOf(keyword)>=0){selNum+=1;userList.push(n)}}else{selNum+=1}});if(userList!=""&&userList.length>0){usersControl.getMoreData(obj,opt,userList)}obj.find(".yt-users-model .yt-user-input").focus();usersControl.events(obj,opt);if(selNum==0){obj.find(".yt-users-list ul").append('<li style="text-align: center;">暂无数据</li>')}},getMoreData:function(obj,opt,datas){var loadPageNum=20;var pageNum=1;var usersUl=$(".yt-users-list ul");obj.find(".yt-users-list ul").empty();var liStr="";$.each(datas,function(i,n){if(i<loadPageNum){liStr+='<li>'+n.userName+'/'+n.deptName+'</li>';liStr=$(liStr).data("userData",n);$(usersUl).append(liStr)}else{liStr+='<li class="more-data" style="text-align: center;color: #417095;border-bottom:0px;">加载更多...</li>';liStr=$(liStr);$(usersUl).append(liStr);return false}});var dataPageTotal=0;obj.find(".yt-users-list ul li.more-data").off().on("click",function(){if(dataPageTotal==0){dataPageTotal=(loadPageNum+1)}else{dataPageTotal+=20}dataPageTotal=parseInt(dataPageTotal);var pageTotal=parseInt(datas.length/loadPageNum);pageNum+=1;var liStr="";for(var i=dataPageTotal;i<(dataPageTotal+20);i+=1){if(datas[i]!=undefined){liStr+='<li>'+datas[i].userName+'/'+datas[i].deptName+'</li>';liStr=$(liStr).data("userData",datas[i]);$(".yt-users-list ul li.more-data").before(liStr)}else{$(this).text("已全部加载").css("color","#D0D0D0").off("click");return}}usersControl.events(obj,opt)});usersControl.events(obj,opt)},setInteractive:function(obj,opt,thisObj){obj.find(".yt-users-model #rightButCon").remove();var html='<div id="rightButCon" class="right-button-context"><div><div class="li-div del-only">清除</div><div class="li-div del-all">清除全部</div><div class="li-div canel-li">取消</div><div></div>';$(thisObj).append(html)},rightButConPosition:function(e){var left=e.clientX;var top=e.clientY;var rightButCon=$('#rightButCon');var width=rightButCon.width();var height=rightButCon.height();var w=$(window);var winWidth=w.width();var winHeight=w.height();left=width+left>winWidth?left-width:left;top=height+top>winHeight?top-height:top;rightButCon.show().css({left:left,top:top})}};$.fn.extend({usersControl:function(opt){var defaults={controlClass:'',dataUrl:'',callback:function(){}};var options=$.extend(defaults,opt);this.ytUsersControl=usersControl;this.ytUsersControl.init($(this),options);return $(this)},setUsersChoose:function(opt){$.each(USERS_LIST,function(i,n){var Itcode=","+n.userItcode+",";if(opt!=undefined&&opt!=null&&opt!=""&&opt.indexOf(Itcode)>=0){usersControl.thisUserObj.find(".yt-users-model .yt-user-input").before($('<span class="user-obj">'+n.userName+'、</span>').data("userData",n))}})}});$(function(){$(document).click(function(e){if(!$(e.target).hasClass("yt-users-list")&&!$(e.target).hasClass("yt-user-input")&&!$(e.target).hasClass("more-data")&&!$(e.target).hasClass("user-obj")){$(".yt-users-list").hide();usersControl.getMoreData(usersControl.thisUserObj,'',USERS_LIST)}});$(document).keydown(function(event){var userItcode="";if($(".yt-users-model .yt-user-input").is(":focus")){if(event.keyCode==8){if($(".yt-users-model span.user-obj").length>0){userItcode=$('.yt-users-model span.user-obj:eq('+($(".yt-users-model span.user-obj").length-1)+')').data("userData").userItcode;$('.yt-users-model span.user-obj:eq('+($(".yt-users-model span.user-obj").length-1)+')').remove()}}}if(userItcode!=undefined&&userItcode!=""){$(".yt-users-list li:not(.more-data)").each(function(i,n){if($(n).data("userData").userItcode==userItcode){$(n).removeClass("user-check-li");return false}})}})})})(jQuery);